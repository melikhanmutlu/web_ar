{% extends "base.html" %}

{% block title %}Home - arvision{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 dark:bg-[#0a0e1a] text-gray-900 dark:text-white relative">
    <div class="abstract-bg"></div>
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="max-w-xl mx-auto mb-6 px-4">
                {% for category, message in messages %}
                    <div class="rounded-lg p-4 mb-4 {% if category == 'error' %}bg-red-100 text-red-700{% elif category == 'success' %}bg-green-100 text-green-700{% else %}bg-blue-100 text-blue-700{% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- Upload Section -->
    <div class="max-w-4xl mx-auto px-4 pt-24 pb-12">
            
            <form id="uploadForm" action="{{ url_for('upload_file') }}" method="post" enctype="multipart/form-data" class="space-y-6">
                <!-- File Upload -->
                <div>
                    <div id="dropZone" class="relative border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-2xl p-16 transition-all duration-300 hover:border-cyan-500 hover:bg-gray-50 dark:hover:bg-[#232938]/50 cursor-pointer text-center group mb-8">
                        <input id="file-upload" name="file" type="file" class="hidden" accept=".obj,.glb,.gltf,.fbx,.stl">
                        <svg class="mx-auto h-24 w-24 text-cyan-500 dark:text-cyan-400 mb-8 group-hover:scale-110 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        <p class="text-gray-900 dark:text-white text-2xl font-semibold mb-3">Drag & drop your 3D models here</p>
                        <p class="text-gray-500 dark:text-gray-400 text-base mb-6">or click to browse</p>
                        <p class="text-gray-400 dark:text-gray-500 text-sm">
                            Supported formats: <span class="text-cyan-600 dark:text-cyan-400 font-medium">FBX, OBJ, GLB, GLTF, STL</span> (max. 100MB)
                        </p>
                        <div id="selectedFileName" class="text-cyan-600 dark:text-cyan-400 text-base font-medium mt-6 hidden"></div>
                    </div>
                </div>

                <!-- MTL File Upload (Optional) -->
                <div id="mtlUpload" class="hidden">
                    <div class="mt-2">
                        <label for="mtl-upload" class="block cursor-pointer">
                            <div class="flex items-center justify-center w-full px-6 pt-5 pb-6 border-2 border-gray-300 dark:border-gray-600 border-dashed rounded-lg hover:border-gray-400 dark:hover:border-gray-500 transition-colors duration-200">
                                <div class="space-y-1 text-center">
                                    <div id="mtlUploadText">
                                        <span class="text-gray-900 dark:text-white font-medium hover:text-gray-600 dark:hover:text-gray-300">Upload MTL file</span>
                                    </div>
                                    <div id="selectedMtlFileName" class="text-sm text-gray-600 dark:text-gray-400 hidden"></div>
                                    <input id="mtl-upload" name="mtl" type="file" class="hidden" accept=".mtl">
                                </div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Texture Files Upload (Optional) -->
                <div id="textureUpload" class="hidden">
                    <div class="mt-2">
                        <label for="texture-upload" class="block cursor-pointer">
                            <div class="flex items-center justify-center w-full px-6 pt-5 pb-6 border-2 border-gray-300 dark:border-gray-600 border-dashed rounded-lg hover:border-gray-400 dark:hover:border-gray-500 transition-colors duration-200">
                                <div class="space-y-1 text-center">
                                    <div id="textureUploadText">
                                        <span class="text-gray-900 dark:text-white font-medium hover:text-gray-600 dark:hover:text-gray-300">Upload texture files</span>
                                    </div>
                                    <div id="selectedTextureFileNames" class="text-sm text-gray-600 dark:text-gray-400 hidden"></div>
                                    <input id="texture-upload" name="textures" type="file" class="hidden" accept=".jpg,.jpeg,.png,.tga,.bmp" multiple>
                                </div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Options Section -->
                <div class="space-y-3">
                    <!-- Maximum Dimension -->
                    <div class="bg-white dark:bg-gray-800/50 rounded-xl p-6 border border-gray-200 dark:border-gray-700 transition-all duration-300">
                        <div class="flex items-center justify-between gap-4">
                            <label class="flex items-center space-x-3 cursor-pointer group">
                                <div class="relative">
                                    <input type="checkbox" 
                                        id="useMaxDimension" 
                                        name="use_max_dimension" 
                                        class="peer sr-only">
                                    <div class="w-11 h-6 bg-gray-700 rounded-full peer peer-checked:bg-cyan-500 transition-all"></div>
                                    <div class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-all peer-checked:translate-x-5"></div>
                                </div>
                                <span class="text-gray-900 dark:text-white font-semibold text-lg">Limit Model Size</span>
                            </label>
                            <div id="maxDimensionInput" class="hidden flex items-center gap-2">
                                <div class="relative">
                                    <input type="number" 
                                        id="max-dimension" 
                                        name="max_dimension" 
                                        min="10" 
                                        max="100" 
                                        value="50" 
                                        class="w-24 px-3 py-2 text-gray-900 dark:text-white bg-white dark:bg-gray-800 border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 pr-10">
                                    <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                        <span class="text-gray-500 dark:text-gray-400 text-sm font-medium">cm</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Color Input -->
                    <div class="bg-white dark:bg-gray-800/50 rounded-xl p-6 border border-gray-200 dark:border-gray-700 transition-all duration-300">
                        <div class="flex items-center justify-between gap-4">
                            <label class="flex items-center space-x-3 cursor-pointer group">
                                <div class="relative">
                                    <input type="checkbox" id="useColor" name="useColor" value="true" class="peer sr-only">
                                    <div class="w-11 h-6 bg-gray-700 rounded-full peer peer-checked:bg-cyan-500 transition-all"></div>
                                    <div class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-all peer-checked:translate-x-5"></div>
                                </div>
                                <span class="text-gray-900 dark:text-white font-semibold text-lg">Apply Color</span>
                            </label>
                            <div id="colorPickerContainer" class="hidden flex items-center gap-3">
                                <input type="color" id="colorPicker" name="color" value="#4CAF50" class="h-10 w-16 rounded-lg border-2 border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 cursor-pointer hover:border-cyan-500 transition-colors">
                                <input type="text" id="colorInput" class="w-32 rounded-lg border-2 border-gray-300 dark:border-gray-600 px-3 py-2 bg-white dark:bg-gray-800 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-sm" value="#4CAF50" pattern="^#[0-9A-Fa-f]{6}$" placeholder="#4CAF50">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Upload Status -->
                <div id="uploadStatus" class="hidden">
                    <style>
                        .progress-wrapper {
                            margin: 1.5rem 0;
                            background: var(--bg-secondary, #f3f4f6);
                            border-radius: 0.5rem;
                            padding: 1.5rem;
                            border: 1px solid var(--border-color, #e5e7eb);
                        }

                        .dark .progress-wrapper {
                            background: var(--bg-secondary-dark, #1f2937);
                            border-color: var(--border-color-dark, #374151);
                        }

                        .progress-status {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 0.75rem;
                        }

                        .progress-label {
                            font-size: 0.875rem;
                            font-weight: 500;
                            color: var(--text-primary, #111827);
                        }

                        .dark .progress-label {
                            color: var(--text-primary-dark, #f3f4f6);
                        }

                        .progress-percentage {
                            font-size: 0.875rem;
                            font-weight: 600;
                            color: var(--text-primary, #111827);
                        }

                        .dark .progress-percentage {
                            color: var(--text-primary-dark, #f3f4f6);
                        }

                        .progress-bar-container {
                            width: 100%;
                            height: 0.5rem;
                            background: var(--bg-primary, #ffffff);
                            border-radius: 0.25rem;
                            overflow: hidden;
                        }

                        .dark .progress-bar-container {
                            background: var(--bg-primary-dark, #111827);
                        }

                        .progress-bar {
                            height: 100%;
                            width: 0%;
                            background: var(--progress-color, #111827);
                            border-radius: 0.25rem;
                            transition: width 0.3s ease, background-color 0.3s ease;
                        }

                        .dark .progress-bar {
                            background: var(--progress-color-dark, #f3f4f6);
                        }

                        .progress-bar.success {
                            background: var(--success-color, #111827);
                        }

                        .dark .progress-bar.success {
                            background: var(--success-color-dark, #f3f4f6);
                        }

                        .progress-bar.error {
                            background: var(--error-color, #dc2626);
                        }

                        .dark .progress-bar.error {
                            background: var(--error-color-dark, #ef4444);
                        }

                        .upload-result {
                            margin-top: 1rem;
                            padding: 1rem;
                            border-radius: 0.5rem;
                            background: var(--bg-primary, #ffffff);
                            border: 1px solid var(--border-color, #e5e7eb);
                            text-align: center;
                        }

                        .dark .upload-result {
                            background: var(--bg-primary-dark, #111827);
                            border-color: var(--border-color-dark, #374151);
                        }

                        .upload-result.success {
                            border-color: var(--success-color, #111827);
                        }

                        .dark .upload-result.success {
                            border-color: var(--success-color-dark, #f3f4f6);
                        }

                        .upload-result.error {
                            border-color: var(--error-color, #dc2626);
                        }

                        .dark .upload-result.error {
                            border-color: var(--error-color-dark, #ef4444);
                        }

                        .view-model-button {
                            display: inline-block;
                            margin-top: 0.75rem;
                            padding: 0.5rem 1rem;
                            background: var(--bg-secondary, #f3f4f6);
                            color: var(--text-primary, #111827);
                            border: 1px solid var(--border-color, #e5e7eb);
                            border-radius: 0.375rem;
                            font-size: 0.875rem;
                            font-weight: 500;
                            text-decoration: none;
                            transition: all 0.2s ease;
                        }

                        .dark .view-model-button {
                            background: var(--bg-secondary-dark, #1f2937);
                            color: var(--text-primary-dark, #f3f4f6);
                            border-color: var(--border-color-dark, #374151);
                        }

                        .view-model-button:hover {
                            background: var(--bg-hover, #e5e7eb);
                        }

                        .dark .view-model-button:hover {
                            background: var(--bg-hover-dark, #374151);
                        }
                    </style>

                    <div class="progress-wrapper">
                        <div class="progress-status">
                            <span class="progress-label" id="uploadStatusText">Uploading...</span>
                            <span class="progress-percentage" id="progressText">0%</span>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="progressBar"></div>
                        </div>
                    </div>
                    <div id="uploadResult" class="upload-result" style="display: none;"></div>
                </div>

                <!-- Submit Button -->
                <button type="submit" class="w-full bg-gradient-to-r from-cyan-500 to-blue-600 text-white rounded-xl py-5 px-8 text-xl font-bold hover:from-cyan-600 hover:to-blue-700 transition-all duration-300 shadow-2xl shadow-cyan-500/40 hover:shadow-cyan-500/60 hover:scale-[1.02] disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100" id="submitBtn" disabled>
                    <span class="flex items-center justify-center">
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        Upload and Convert
                    </span>
                </button>
            </form>

        <!-- Features Section -->
        <div class="max-w-7xl mx-auto px-4 py-12">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Card 1: Multiple Formats -->
                <div class="rounded-2xl p-8 text-center hover:scale-105 transition-all duration-300 border border-gray-200/50 dark:border-gray-700/30 hover:border-cyan-400 shadow-sm hover:shadow-lg hover:shadow-cyan-500/10">
                    <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-cyan-500/20 flex items-center justify-center">
                        <svg class="w-8 h-8 text-cyan-500 dark:text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-3">Multiple Formats</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Support for FBX, OBJ, STL, and GLTF with textures and materials</p>
                </div>

                <!-- Card 2: AR Ready -->
                <div class="rounded-2xl p-8 text-center hover:scale-105 transition-all duration-300 border border-gray-200/50 dark:border-gray-700/30 hover:border-red-400 shadow-sm hover:shadow-lg hover:shadow-red-500/10">
                    <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-red-500/20 flex items-center justify-center">
                        <svg class="w-8 h-8 text-red-500 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                        </svg>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-3">AR Ready</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400">View your models in AR on iPhone and Android devices</p>
                </div>

                <!-- Card 3: Fast Conversion -->
                <div class="rounded-2xl p-8 text-center hover:scale-105 transition-all duration-300 border border-gray-200/50 dark:border-gray-700/30 hover:border-green-400 shadow-sm hover:shadow-lg hover:shadow-green-500/10">
                    <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-green-500/20 flex items-center justify-center">
                        <svg class="w-8 h-8 text-green-500 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-3">Fast Conversion</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Quick and efficient conversion process</p>
                </div>

                <!-- Card 4: Save History -->
                <div class="rounded-2xl p-8 text-center hover:scale-105 transition-all duration-300 border border-gray-200/50 dark:border-gray-700/30 hover:border-orange-400 shadow-sm hover:shadow-lg hover:shadow-orange-500/10">
                    <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-orange-500/20 flex items-center justify-center">
                        <svg class="w-8 h-8 text-orange-500 dark:text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                        </svg>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-3">Save History</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Registered users can access their conversion history</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('file-upload');
        const selectedFileName = document.getElementById('selectedFileName');
        const uploadForm = document.getElementById('uploadForm');
        const uploadResult = document.getElementById('uploadResult');

        // Initialize color picker functionality
        const colorPickerCheckbox = document.getElementById('useColor');
        const colorPickerContainer = document.getElementById('colorPickerContainer');
        const colorPicker = document.getElementById('colorPicker');
        const colorInput = document.getElementById('colorInput');
        
        if (colorPickerCheckbox && colorPickerContainer) {
            colorPickerCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    colorPickerContainer.classList.remove('hidden');
                } else {
                    colorPickerContainer.classList.add('hidden');
                }
            });
        }
        
        // Sync color picker and text input
        if (colorPicker && colorInput) {
            colorPicker.addEventListener('input', function() {
                colorInput.value = this.value.toUpperCase();
            });
            
            colorInput.addEventListener('input', function() {
                const value = this.value.trim();
                // Validate hex color format
                if (/^#[0-9A-Fa-f]{6}$/.test(value)) {
                    colorPicker.value = value;
                    this.classList.remove('border-red-500');
                } else {
                    this.classList.add('border-red-500');
                }
            });
        }

        // Prevent default drag behaviors
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });

        // Highlight drop zone when item is dragged over it
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, unhighlight, false);
        });

        // Handle dropped files
        dropZone.addEventListener('drop', (e) => {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                handleFiles(files);
                fileInput.files = files; // Set the files to the input element
            }
        });

        // Handle clicked files
        dropZone.addEventListener('click', () => {
            fileInput.click();
        });

        // Handle selected files
        const submitBtn = document.getElementById('submitBtn');
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFiles(e.target.files);
                submitBtn.disabled = false; // Enable submit button
            }
        });

        // Handle MTL file selection
        const mtlInput = document.getElementById('mtl-upload');
        const selectedMtlFileName = document.getElementById('selectedMtlFileName');
        const mtlUploadText = document.getElementById('mtlUploadText');
        
        mtlInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
                selectedMtlFileName.innerHTML = `Selected: ${file.name}<br>(${fileSizeMB} MB)`;
                selectedMtlFileName.classList.remove('hidden');
                mtlUploadText.classList.add('hidden');
            } else {
                selectedMtlFileName.classList.add('hidden');
                mtlUploadText.classList.remove('hidden');
            }
        });

        // Handle texture files selection
        const textureInput = document.getElementById('texture-upload');
        const selectedTextureFileNames = document.getElementById('selectedTextureFileNames');
        const textureUploadText = document.getElementById('textureUploadText');
        
        textureInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                const files = Array.from(e.target.files);
                const totalSizeMB = (files.reduce((total, file) => total + file.size, 0) / (1024 * 1024)).toFixed(2);
                const fileList = files.map(file => file.name).join('<br>');
                selectedTextureFileNames.innerHTML = `Selected ${files.length} file(s):<br>${fileList}<br>Total: ${totalSizeMB} MB`;
                selectedTextureFileNames.classList.remove('hidden');
                textureUploadText.classList.add('hidden');
            } else {
                selectedTextureFileNames.classList.add('hidden');
                textureUploadText.classList.remove('hidden');
            }
        });

        function handleFiles(files) {
            const file = files[0];
            if (file) {
                // Check file type
                const validExtensions = ['.obj', '.glb', '.gltf', '.fbx', '.stl'];
                const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
                
                if (!validExtensions.includes(fileExtension)) {
                    displayError('Invalid file type. Please upload a 3D model file (OBJ, GLB, GLTF, FBX, or STL).');
                    return;
                }

                // Check file size (10MB limit)
                const maxSize = 100 * 1024 * 1024; // 100MB in bytes
                if (file.size > maxSize) {
                    displayError('File size exceeds 100MB limit. Please choose a smaller file.');
                    return;
                }

                // Update the filename display
                const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
                selectedFileName.innerHTML = `Selected: ${file.name}<br>(${fileSizeMB} MB)`;
                selectedFileName.classList.remove('hidden');
                
                // Enable submit button
                const submitBtn = document.getElementById('submitBtn');
                if (submitBtn) submitBtn.disabled = false;

                // Show/hide MTL and texture upload based on file type
                const mtlUpload = document.getElementById('mtlUpload');
                const textureUpload = document.getElementById('textureUpload');
                
                if (fileExtension === '.obj') {
                    mtlUpload?.classList.remove('hidden');
                    textureUpload?.classList.remove('hidden');
                } else {
                    mtlUpload?.classList.add('hidden');
                    textureUpload?.classList.add('hidden');
                }
            }
        }

        function displayError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'bg-red-100 text-red-700 p-4 rounded-lg mb-4';
            errorDiv.innerHTML = `
                <div class="font-medium">Upload Failed</div>
                <div class="mt-1 text-sm">${message}</div>
            `;
            
            // Remove any existing error messages
            const existingError = uploadForm.querySelector('.bg-red-100');
            if (existingError) {
                existingError.remove();
            }
            
            // Insert error message at the top of the form
            uploadForm.insertBefore(errorDiv, uploadForm.firstChild);
            
            // Clear the file input
            fileInput.value = '';
            selectedFileName.classList.add('hidden');
        }

        function highlight(e) {
            dropZone.classList.add('border-gray-900', 'dark:border-white', 'bg-gray-50', 'dark:bg-gray-700/50');
        }

        function unhighlight(e) {
            dropZone.classList.remove('border-gray-900', 'dark:border-white', 'bg-gray-50', 'dark:bg-gray-700/50');
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        // Handle form submission
        uploadForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('file-upload');
            const file = fileInput.files[0];
            
            if (!file) {
                displayError('Please select a file to upload.');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            // Check if color should be applied
            const useColorCheckbox = document.getElementById('useColor');
            const shouldApplyColor = useColorCheckbox && useColorCheckbox.checked;
            formData.append('useColor', shouldApplyColor ? 'true' : 'false');
            formData.append('color', document.getElementById('colorPicker').value);
            
            const useMaxDimensionCheckbox = document.getElementById('useMaxDimension');
            const shouldLimitDimension = useMaxDimensionCheckbox && useMaxDimensionCheckbox.checked;
            formData.append('useMaxDimension', shouldLimitDimension ? 'true' : 'false');
            formData.append('maxDimension', document.getElementById('max-dimension').value);
            
            const removeTexturesCheckbox = document.getElementById('removeTextures');
            const shouldRemoveTextures = removeTexturesCheckbox && removeTexturesCheckbox.checked;
            formData.append('removeTextures', shouldRemoveTextures ? 'true' : 'false');
            
            console.log('Upload settings:', {
                useColor: shouldApplyColor,
                color: document.getElementById('colorPicker').value,
                useMaxDimension: shouldLimitDimension,
                maxDimension: document.getElementById('max-dimension').value,
                removeTextures: shouldRemoveTextures
            });
            
            // Add MTL file if present (for OBJ files)
            const mtlInput = document.getElementById('mtl-upload');
            if (mtlInput && mtlInput.files.length > 0) {
                formData.append('mtl', mtlInput.files[0]);
                console.log('MTL file added:', mtlInput.files[0].name);
            }
            
            // Add texture files if present (for OBJ files)
            const textureInput = document.getElementById('texture-upload');
            if (textureInput && textureInput.files.length > 0) {
                for (let i = 0; i < textureInput.files.length; i++) {
                    formData.append('textures', textureInput.files[i]);
                    console.log('Texture file added:', textureInput.files[i].name);
                }
            }
            
            // Reset progress bar and show upload status
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const statusText = document.getElementById('uploadStatusText');
            const uploadStatus = document.getElementById('uploadStatus');
            const uploadResult = document.getElementById('uploadResult');

            progressBar.style.width = '0%';
            progressText.textContent = '0%';
            uploadStatus.style.display = 'block';
            uploadResult.style.display = 'none';
            
            let isUploading = true;
            let progress = 0;

            // Simulated progress
            const progressInterval = setInterval(() => {
                if (!isUploading) {
                    clearInterval(progressInterval);
                    return;
                }

                if (progress < 90) {
                    progress += Math.random() * 10;
                    progress = Math.min(progress, 90);
                    progressBar.style.width = progress + '%';
                    progressText.textContent = Math.round(progress) + '%';
                    statusText.textContent = 'Uploading and converting...';
                }
            }, 200);

            // Upload file
            fetch('/upload_model', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(response => {
                isUploading = false;
                if (response.success) {
                    uploadResult.className = 'upload-result success';
                    uploadResult.style.display = 'block';
                    
                    // Önce progress bar'ı 100% yapalım
                    progressBar.style.width = '100%';
                    progressText.textContent = '100%';
                    statusText.textContent = 'Upload completed';
                    
                    // Kısa bir gecikme sonra başarı mesajını gösterelim
                    setTimeout(() => {
                        uploadResult.innerHTML = `
                            <div style="color: var(--text-primary, #111827);" class="dark:text-gray-100">
                                ${response.message}
                            </div>
                        `;
                        
                        // 1 saniye sonra yönlendirelim
                        setTimeout(() => {
                            window.location.href = response.viewer_url;
                        }, 1000);
                    }, 500);
                } else {
                    throw new Error(response.error || 'Upload failed');
                }
            })
            .catch(error => {
                isUploading = false;
                progressBar.classList.add('error');
                uploadResult.className = 'upload-result error';
                uploadResult.style.display = 'block';
                uploadResult.innerHTML = `
                    <div class="text-red-600">
                        ${error.message}
                    </div>
                `;
            });
        });
    });
    // Handle max dimension checkbox
    const useMaxDimension = document.getElementById('useMaxDimension');
    const maxDimensionInput = document.getElementById('maxDimensionInput');

    useMaxDimension.addEventListener('change', function() {
        maxDimensionInput.classList.toggle('hidden', !this.checked);
    });
</script>
{% endblock %}
